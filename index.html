<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Musiqa Qidiruv</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://sad.adsgram.ai/js/sad.min.js"></script>

<style>
body {
    font-family: Arial;
    background: #111;
    color: white;
    padding: 20px;
}
input {
    width: 100%;
    padding: 13px;
    border-radius: 10px;
    border: none;
    margin-bottom: 20px;
    font-size: 17px;
}
.music-card {
    background: #222;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    overflow-wrap: break-word; 
    word-break: break-word;
}
.btn-download {
    margin-top: 10px;
    display: inline-block;
    padding: 8px 12px;
    background: #0af;
    color: white;
    border-radius: 8px;
    text-decoration: none;
}
</style>
</head>

<body>

<h2>Musiqa qidiruv ðŸŽµ</h2>

<input type="text" id="search" placeholder="Musiqa nomini yozing...">

<div id="musicList"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
// === BOUNTYHASH USULI: SESSÄ°YANI SAQLASH VA TIKLASH ===
(function() {
    const STORAGE_KEY = 'tg_session_data';
    
    // 1. URL'dan ma'lumotni tekshirish (#tgWebAppData=...)
    const urlParams = new URLSearchParams(window.location.hash.replace('#', '?'));
    const tgDataFromUrl = urlParams.get('tgWebAppData');

    if (tgDataFromUrl) {
        // Agar botdan kirgan bo'lsa, ma'lumotni xotiraga saqlaymiz
        localStorage.setItem(STORAGE_KEY, tgDataFromUrl);
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.initData = tgDataFromUrl;
        }
        console.log("Yangi sessiya saqlandi.");
    } else {
        // Agar brauzerda ochilsa, xotiradagi eski ma'lumotni tiklaymiz
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData && window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.initData = savedData;
            console.log("Eski sessiya xotiradan tiklandi. Reklama chiqishi mumkin.");
        }
    }
    
    // Telegram SDK'ni tayyorlash
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
    }
})();

// === FIREBASE KONFIGURATSIYASI ===
const firebaseConfig = {
  apiKey: "AIzaSyApRt8MNq4YvsjxQVhyQK3p5km8G7Hi9iE",
  authDomain: "webtelegram-9a1d6.firebaseapp.com",
  projectId: "webtelegram-9a1d6", 
  storageBucket: "webtelegram-9a1d6.firebasestorage.app",
  messagingSenderId: "991268167197",
  appId: "1:991268167197:web:5a2b0ad266c20c6e00b0f4",
  measurementId: "G-M7MR2JTT4L"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database(); 
let musics = [];

// === REKLAMA KO'RSATISH FUNKSIYASI ===
function showInterstitial() {
    if (window.Adsgram) {
        const AdController = window.Adsgram.init({
            blockId: "int-18073", 
            type: "interstitial",
            debug: false // Haqiqiy reklama uchun false
        });

        AdController.show().then((result) => {
            console.log("Reklama ko'rsatildi:", result);
        }).catch((e) => {
            console.error("AdsGram xatosi:", e);
        });
    }
}

// Sahifa ochilganda reklama yuklashga urinish
setTimeout(showInterstitial, 1500);

// === MUSIQA CHIQARISH ===
function renderList(filtered) {
    let list = document.getElementById("musicList");
    list.innerHTML = "";
    
    if (filtered.length === 0) {
        list.innerHTML = "<p style='text-align: center; margin-top: 50px;'>Hech qanday musiqa topilmadi.</p>";
        return;
    }

    filtered.forEach(m => {
        let div = document.createElement("div");
        div.className = "music-card";
        div.innerHTML = `
            ${m.name}<br>
            <a class="btn-download" href="${m.link}" target="_blank">Yuklab olish â¬‡</a>
        `;
        list.appendChild(div);
    });

    let downloadButtons = document.querySelectorAll(".btn-download");
    let downloadCount = 0;

    downloadButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            downloadCount++;
            if (downloadCount >= 5) {
                showInterstitial(); 
                downloadCount = 0;
            }
        });
    });
}

// === FIREBASE'DAN YUKLASH ===
function loadMusics() {
    const musicRef = db.ref('musics');
    const musicListElement = document.getElementById("musicList");
    musicListElement.innerHTML = "Yuklanmoqda...";

    musicRef.on('value', (snapshot) => {
        musics = [];
        const data = snapshot.val();
        if (data) {
            Object.keys(data).forEach(key => {
                musics.push({ id: key, name: data[key].name, link: data[key].link });
            });
        }
        musics.sort((a, b) => a.name.localeCompare(b.name));
        renderList(musics);
    }, (error) => {
        musicListElement.innerHTML = "<p>Xatolik yuz berdi.</p>";
    });
}

document.addEventListener("DOMContentLoaded", loadMusics);

// === QIDIRUV + AUTO REKLAMA ===
let searchCount = 0;
let typingTimer;
document.getElementById("search").addEventListener("input", function () {
    clearTimeout(typingTimer);
    const value = this.value.toLowerCase();

    typingTimer = setTimeout(() => {
        const filtered = musics.filter(m => m.name.toLowerCase().includes(value));
        renderList(filtered);
        searchCount++;
        if (searchCount >= 5) {
            showInterstitial(); 
            searchCount = 0;
        }
    }, 1000);
});
</script>

</body>
</html>
